From 1715f15141c7516f9a8faf8837d4c295f727a28b Mon Sep 17 00:00:00 2001
From: Mikhail Anikin <mikhail.anikin@solid-run.com>
Date: Wed, 30 Aug 2023 10:44:04 +0300
Subject: [PATCH] rzg2l: Add pmic initialization

---
 arch/arm/dts/rzg2l-solidrun.dts        | 19 ++++++--
 board/solidrun/rzg-common/Makefile     |  2 +-
 board/solidrun/rzg-common/rzg-common.h |  2 +
 board/solidrun/rzg-common/rzg-pmic.c   | 65 ++++++++++++++++++++++++++
 board/solidrun/rzg2l/rzg2l-solidrun.c  | 13 ++++++
 5 files changed, 96 insertions(+), 5 deletions(-)
 create mode 100644 board/solidrun/rzg-common/rzg-pmic.c

diff --git a/arch/arm/dts/rzg2l-solidrun.dts b/arch/arm/dts/rzg2l-solidrun.dts
index da524ab6..69fe5459 100644
--- a/arch/arm/dts/rzg2l-solidrun.dts
+++ b/arch/arm/dts/rzg2l-solidrun.dts
@@ -40,12 +40,12 @@
 	pinctrl-0 = <&pinctrl_hog>;
 	pinctrl_hog: hoggrp {
 		pinmux = <RZG2L_PINMUX(22, 1, 0)>, /* SD0_DEV_SEL_SW */
-				<RZG2L_PINMUX(23, 0, 0)>, /* BT_REG_ON */
-				<RZG2L_PINMUX(23, 1, 0)>; /* WL_REG_ON */ 
+			<RZG2L_PINMUX(23, 0, 0)>, /* BT_REG_ON */
+			<RZG2L_PINMUX(23, 1, 0)>; /* WL_REG_ON */ 
 	};
 
 	eth0_pins: eth0 {
-	pinmux = <RZG2L_PINMUX(28, 1, 1)>, /* ET0_LINKSTA */
+		pinmux = <RZG2L_PINMUX(28, 1, 1)>, /* ET0_LINKSTA */
 			<RZG2L_PINMUX(27, 1, 1)>, /* ET0_MDC */
 			<RZG2L_PINMUX(28, 0, 1)>, /* ET0_MDIO */
 			<RZG2L_PINMUX(20, 0, 1)>, /* ET0_TXC */
@@ -78,7 +78,12 @@
 			<RZG2L_PINMUX(35, 0, 1)>, /* ET1_RXD1 */
 			<RZG2L_PINMUX(35, 1, 1)>, /* ET1_RXD2 */
 			<RZG2L_PINMUX(36, 0, 1)>; /* ET1_RXD3 */
-  };
+	};
+
+	i2c3_pins: i2c3 {
+		pinmux = <RZG2L_PINMUX(18, 0, 3)>, /* SDA */
+			<RZG2L_PINMUX(18, 1, 3)>; /* SCL */
+	};
 
 };
 
@@ -157,6 +162,12 @@
 	};
 };
 
+&i2c3 {
+	pinctrl-0 = <&i2c3_pins>;
+	pinctrl-names = "default";
+	status = "okay";
+};
+
 &usb2_phy0 {
 	status = "okay";
 };
diff --git a/board/solidrun/rzg-common/Makefile b/board/solidrun/rzg-common/Makefile
index efc83ca7..0345ffc9 100644
--- a/board/solidrun/rzg-common/Makefile
+++ b/board/solidrun/rzg-common/Makefile
@@ -2,4 +2,4 @@
 # SPDX-License-Identifier: GPL-2.0+
 #
 
-obj-$(CONFIG_RZG_SOLIDRUN_COMMON) += rzg-common.o
+obj-$(CONFIG_RZG_SOLIDRUN_COMMON) += rzg-common.o rzg-pmic.o
diff --git a/board/solidrun/rzg-common/rzg-common.h b/board/solidrun/rzg-common/rzg-common.h
index 180e882d..16fc0ae2 100644
--- a/board/solidrun/rzg-common/rzg-common.h
+++ b/board/solidrun/rzg-common/rzg-common.h
@@ -27,4 +27,6 @@ void rzg_sd_emmc_init(void);
 int rzg_preboot_sd_emmc_setup(void *blob, struct bd_info *bd);
 #endif
 
+int raa215300_int_32k_init(struct udevice *i2c_bus);
+
 #endif //__RZG_COMMON_H__
diff --git a/board/solidrun/rzg-common/rzg-pmic.c b/board/solidrun/rzg-common/rzg-pmic.c
new file mode 100644
index 00000000..2b0f02f8
--- /dev/null
+++ b/board/solidrun/rzg-common/rzg-pmic.c
@@ -0,0 +1,65 @@
+#include <common.h>
+#include <i2c.h>
+#include "rzg-common.h"
+
+#define I2C_ADDR_PMIC 0x12
+#define I2C_ADDR_RTC 0x6f
+
+int raa215300_rtc_init(struct udevice *pmic)
+{
+    int ret = dm_i2c_reg_write(pmic, 0x6c, 0x40);
+    if (ret)
+    {
+        pr_err("%s: can't enable rtc, %d \n", __func__, ret);
+        return ret;
+    }
+    ret = dm_i2c_reg_write(pmic, 0x68, 0x8);
+    if (ret)
+    {
+        pr_err("%s: can't mask the int# bit, %d \n", __func__, ret);
+        return ret;
+    }
+    return 0;
+}
+
+int raa215300_rtc_enable_clk(struct udevice *rtc)
+{
+    int ret = dm_i2c_reg_write(rtc, 0x7, 0x10);
+    if (ret)
+    {
+        pr_err("%s: can't enable rtc, %d \n", __func__, ret);
+        return ret;
+    }
+    ret = dm_i2c_reg_write(rtc, 0x8, 0x11);
+    if (ret)
+    {
+        pr_err("%s: can't enable int# clock, %d \n", __func__, ret);
+        return ret;
+    }
+    return 0;
+}
+
+int raa215300_int_32k_init(struct udevice *i2c_bus)
+{
+    int ret;
+    struct udevice *pmic, *rtc;
+
+    ret = dm_i2c_probe(i2c_bus, I2C_ADDR_PMIC, 0, &pmic);
+    if (ret)
+    {
+        pr_err("Can't probe pmic, ret: %d \n", ret);
+        return ret;
+    }
+    ret = raa215300_rtc_init(pmic);
+    if (ret)
+        return ret;
+
+    ret = dm_i2c_probe(i2c_bus, I2C_ADDR_RTC, 0, &rtc);
+    if (ret)
+    {
+        pr_err("Can't probe rtc, ret: %d \n", ret);
+        return ret;
+    }
+    ret = raa215300_rtc_enable_clk(rtc);
+    return ret;
+}
diff --git a/board/solidrun/rzg2l/rzg2l-solidrun.c b/board/solidrun/rzg2l/rzg2l-solidrun.c
index 21068650..20b6d041 100644
--- a/board/solidrun/rzg2l/rzg2l-solidrun.c
+++ b/board/solidrun/rzg2l/rzg2l-solidrun.c
@@ -175,6 +175,18 @@ static void carrier_select_fdt(int carrier)
 	}
 }
 
+int board_pmic_init(void) 
+{
+	struct udevice *i2c_bus;
+	int ret;
+	ret = uclass_get_device(UCLASS_I2C, 2, &i2c_bus);
+	if (ret) {
+		pr_err("%s: can't get i2c bus, %d\n", __func__, ret);
+		return ret;
+	}
+	return raa215300_int_32k_init(i2c_bus);
+}
+
 int board_late_init(void)
 {
 #ifndef CONFIG_SOLIDRUN_DISABLE_TLV
@@ -190,6 +202,7 @@ int board_late_init(void)
 #endif
 
 	rzg_sd_emmc_init();
+	board_pmic_init();
 
 	return 0;
 }
-- 
2.41.0

